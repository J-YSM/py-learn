<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- saved from url=(0043)http://www.behnel.de/cython200910/talk.html -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="generator" content="Docutils 0.5: http://docutils.sourceforge.net/">
<meta name="version" content="S5 1.1">
<title>Using the Cython Compiler to write fast Python code</title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 5196 2007-06-03 20:25:28Z wiemann $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left {
  clear: left }

img.align-right {
  clear: right }

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font-family: serif ;
  font-size: 100% }

pre.literal-block, pre.doctest-block {
  margin-left: 2em ;
  margin-right: 2em }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
<!-- configuration parameters -->
<meta name="defaultView" content="slideshow">
<meta name="controlVis" content="hidden">
<!-- style sheet links -->
<script src="./Using the Cython Compiler to write fast Python code_files/slides.js.download" type="text/javascript"></script>
<link rel="stylesheet" href="./Using the Cython Compiler to write fast Python code_files/slides.css" type="text/css" media="screen" id="slideProj">
<link rel="stylesheet" href="./Using the Cython Compiler to write fast Python code_files/outline.css" type="text/css" media="screen" id="outlineStyle" disabled="">
<link rel="stylesheet" href="./Using the Cython Compiler to write fast Python code_files/print.css" type="text/css" media="print" id="slidePrint">
<link rel="stylesheet" href="./Using the Cython Compiler to write fast Python code_files/opera.css" type="text/css" media="projection" id="operaFix">
<style media="screen, projection" id="s5ss">body {font-size: 31px !important;}</style></head>
<body>
<div class="layout">
<div id="controls"><form action="http://www.behnel.de/cython200910/talk.html#" id="controlForm" onmouseover="showHide(&#39;s&#39;);" onmouseout="showHide(&#39;h&#39;);"><div id="navLinks" class="hideme"><a accesskey="t" id="toggle" href="javascript:toggle();">Ø</a><a accesskey="z" id="prev" href="javascript:go(-1);">«</a><a accesskey="x" id="next" href="javascript:go(1);">»</a><div id="navList"><select id="jumplist" onchange="go(&#39;j&#39;);"><option value="0">0 : Using the Cython Compiler to write fast Python code</option><option value="1">1 : About myself</option><option value="2">2 : Part 1: Intro to Cython</option><option value="3">3 : What is Cython?</option><option value="4">4 : What is Cython?</option><option value="5">5 : What is Cython?</option><option value="6">6 : Major Cython Core Developers</option><option value="7">7 : How to use Cython</option><option value="8">8 : Example: compiling Python code</option><option value="9">9 : Example: compiling Python code</option><option value="10">10 : Portable Code</option><option value="11">11 : Python language feature support</option><option value="12">12 : Python features in work</option><option value="13">13 : Planned Cython features</option><option value="14">14 : Currently unsupported</option><option value="15">15 : Speed</option><option value="16">16 : Type declarations</option><option value="17">17 : Part 2: Building Cython modules</option><option value="18">18 : Ways to build Cython code</option><option value="19">19 : Example: distutils</option><option value="20">20 : Example: pyximport</option><option value="21">21 : pyximporting Python modules</option><option value="22">22 : Writing executable programs</option><option value="23">23 : Writing executable programs</option><option value="24">24 : Part 3: Writing fast code</option><option value="25">25 : A simple example</option><option value="26">26 : Type declarations in Cython</option><option value="27">27 : Type declarations in Cython</option><option value="28">28 : Functions: def vs. cdef vs. cpdef</option><option value="29">29 : Typed arguments and return values</option><option value="30">30 : A simple example: Python</option><option value="31">31 : A simple example: Cython</option><option value="32">32 : Overriding declarations in .pxd</option><option value="33">33 : Overriding declarations in .pxd</option><option value="34">34 : The .pxd file used</option><option value="35">35 : Overriding declarations in .pxd</option><option value="36">36 : Typing in Python syntax</option><option value="37">37 : Typing in Python syntax</option><option value="38">38 : Declaring Python types</option><option value="39">39 : Declaring Python types: dict</option><option value="40">40 : Declaring Python types: dict</option><option value="41">41 : Declaring Python types: dict</option><option value="42">42 : Think twice before you type</option><option value="43">43 : Classes</option><option value="44">44 : cdef classes - when to use them?</option><option value="45">45 : Part 4: Talking to other extensions</option><option value="46">46 : Talking to other extensions</option><option value="47">47 : Python 3 buffer protocol</option><option value="48">48 : Conclusion</option><option value="49">49 : ... but Cython is also</option><option value="50">50 : Cython</option></select></div></div></form></div>
<div id="currentSlide" style="visibility: visible;"><span id="csHere">2</span> <span id="csSep">/</span> <span id="csTotal">50</span></div>
<div id="header">

</div>
<div id="footer">
<h1>Using the Cython Compiler to write fast Python code</h1>
<h2>Dr. Stefan Behnel</h2>
</div>
</div>
<div class="presentation">
<div class="slide" id="slide0" style="visibility: hidden;">
<h1 class="title">Using the Cython Compiler to write fast Python code</h1>
<h2 class="subtitle" id="dr-stefan-behnel">Dr. Stefan Behnel</h2>

<p class="center"><a class="reference external" href="http://cython.org/">http://cython.org/</a></p>
<p class="center"><a class="reference external" href="mailto:cython-dev@codespeak.net">cython-dev@codespeak.net</a></p>
<p class="center"><a class="reference external" href="mailto:cython-users@googlegroups.com">cython-users@googlegroups.com</a></p>
<!-- , FACETS CodeJam 2009, Freiburg, Germany -->
<!-- Definitions of interpreted text roles (classes) for S5/HTML data. -->
<!-- This data file has been placed in the public domain. -->
<!-- Colours
======= -->
<!-- Text Sizes
========== -->
<!-- Display in Slides (Presentation Mode) Only
========================================== -->
<!-- Display in Outline Mode Only
============================ -->
<!-- Display in Print Only
===================== -->
<!-- Display in Handout Mode Only
============================ -->
<!-- Incremental Display
=================== -->

</div>
<div class="slide" id="slide1" style="visibility: hidden;">
<h1>About myself</h1>
<ul class="simple">
<li>Passionate Python developer since 2002<ul>
<li>after Basic, Logo, Pascal, Prolog, Scheme, Java, C, ...</li>
</ul>
</li>
<li>CS studies in Germany, Ireland, France</li>
<li>PhD in distributed systems in 2007<ul>
<li>Language design for self-organising systems</li>
<li>Darmstadt University of Technologies, Germany</li>
</ul>
</li>
<li>Current occupations:<ul>
<li>Employed by Senacor Technologies AG, Germany<ul>
<li>IT transformations, SOA design, Java-Development, ...</li>
</ul>
</li>
<li>»lxml« OpenSource XML toolkit for Python<ul>
<li><a class="reference external" href="http://codespeak.net/lxml/">http://codespeak.net/lxml/</a></li>
</ul>
</li>
<li>»Cython«</li>
</ul>
</li>
</ul>
</div>
<div class="slide" id="slide2" style="visibility: visible;">
<h1>Part 1: Intro to Cython</h1>
<ul class="simple">
<li><strong>Part 1: Intro to Cython</strong></li>
<li>Part 2: Building Cython modules</li>
<li>Part 3: Writing fast code</li>
<li>Part 4: Talking to other extensions</li>
</ul>
</div>
<div class="slide" id="slide3" style="visibility: hidden;">
<h1>What is Cython?</h1>
<blockquote>
<div class="line-block">
<div class="line"><strong>Cython</strong> is the missing link</div>
<div class="line">between the <strong>simplicity of Python</strong></div>
<div class="line">and the <strong>speed of C</strong> / C++ / Fortran.</div>
</div>
<img alt="SimplicityVsSpeed1.png" src="./Using the Cython Compiler to write fast Python code_files/SimplicityVsSpeed1.png">
</blockquote>
</div>
<div class="slide" id="slide4" style="visibility: hidden;">
<h1>What is Cython?</h1>
<blockquote>
<div class="line-block">
<div class="line"><strong>Cython</strong> is the missing link</div>
<div class="line">between the <strong>simplicity of Python</strong></div>
<div class="line">and the <strong>speed of C</strong> / C++ / Fortran.</div>
</div>
<img alt="SimplicityVsSpeed.png" src="./Using the Cython Compiler to write fast Python code_files/SimplicityVsSpeed.png">
</blockquote>
</div>
<div class="slide" id="slide5" style="visibility: hidden;">
<h1>What is Cython?</h1>
<p><strong>Cython</strong> is</p>
<ul class="simple">
<li>an Open-Source project<ul>
<li><a class="reference external" href="http://cython.org/">http://cython.org</a></li>
<li><a class="reference external" href="http://pypi.python.org/pypi/Cython">http://pypi.python.org/pypi/Cython</a></li>
</ul>
</li>
<li>a Python compiler (almost)<ul>
<li>an enhanced, optimising fork of Pyrex</li>
</ul>
</li>
<li>an extended Python language for<ul>
<li>writing fast Python extension modules</li>
<li>interfacing Python with C libraries</li>
</ul>
</li>
</ul>
</div>
<div class="slide" id="slide6" style="visibility: hidden;">
<h1>Major Cython Core Developers</h1>
<ul class="simple">
<li>Robert Bradshaw, Stefan Behnel, Dag Sverre Seljebotn<ul>
<li>lead developers</li>
</ul>
</li>
<li>Lisandro Dalcín<ul>
<li>C/C++ portability and various feature patches</li>
</ul>
</li>
<li>Kurt Smith, Danilo Freitas<ul>
<li>Google Summer of Code 2009: Fortran/C++ integration</li>
</ul>
</li>
<li>Greg Ewing<ul>
<li>main developer and maintainer of Pyrex</li>
</ul>
</li>
<li>many, <em>many</em> others - see<ul>
<li><a class="reference external" href="http://cython.org/">http://cython.org/</a></li>
<li>the mailing list archives of Cython and Pyrex</li>
</ul>
</li>
</ul>
</div>
<div class="slide" id="slide7" style="visibility: hidden;">
<h1>How to use Cython</h1>
<ul class="simple">
<li>you write Python code<ul>
<li>Cython translates it into C code</li>
<li>your C compiler builds a shared library for CPython</li>
<li>you import your module into CPython</li>
</ul>
</li>
<li>Cython has support for<ul>
<li>distutils<ul>
<li><em>optionally</em> compile Python code from setup.py!<ul>
<li>Cython does that for its own modules :-)</li>
</ul>
</li>
</ul>
</li>
<li>embedding the CPython runtime in an executable</li>
</ul>
</li>
</ul>
</div>
<div class="slide" id="slide8" style="visibility: hidden;">
<h1>Example: compiling Python code</h1>
<div class="syntax"><pre><span style="color: #408080; font-style: italic"># file: worker.py</span>

<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">HardWorker</span>(<span style="color: #008000">object</span>):
    <span style="color: #BA2121">u"Almost Sisyphos"</span>

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, task):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>task <span style="color: #666666">=</span> task

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">work_hard</span>(<span style="color: #008000">self</span>, repeat<span style="color: #666666">=100</span>):
        <span style="color: #008000; font-weight: bold">for</span> i <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(repeat):
            <span style="color: #008000">self</span><span style="color: #666666">.</span>task()


<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">add_simple_stuff</span>():
    x <span style="color: #666666">=</span> <span style="color: #666666">1+1</span>

HardWorker(add_simple_stuff)<span style="color: #666666">.</span>work_hard()
</pre></div>
</div>
<div class="slide" id="slide9">
<h1>Example: compiling Python code</h1>
<ul>
<li><p class="first">compile with</p>
<div class="syntax"><pre><span style="color: #19177C">$ </span>cython worker.py
</pre></div>
</li>
<li><p class="first">translates to ~1500 line <a class="reference external" href="http://www.behnel.de/cython200910/code/worker.c.gz">.c file</a> (Cython 0.11.3)</p>
<ul class="simple">
<li>lots of portability #define's<ul>
<li>different C compilers, Python versions, ...</li>
</ul>
</li>
<li>tons of helpful C comments with Python code snippets<ul>
<li>helps tracing your own code in generated sources</li>
</ul>
</li>
<li>a lot of code that you don't want to write yourself</li>
</ul>
</li>
</ul>
</div>
<div class="slide" id="slide10">
<h1>Portable Code</h1>
<ul class="simple">
<li>Cython compiler generates C code that compiles<ul>
<li>with all major compilers (C and C++)</li>
<li>on all major platforms</li>
<li>in Python 2.3 through 3.1</li>
</ul>
</li>
<li>Cython language syntax follows Python 2.6<ul>
<li>optional Python 3 syntax support is on TODO list<ul>
<li>get involved to get it quicker!</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>... the fastest way to port Python 2 code to Py3 ;-)</p>
</div>
<div class="slide" id="slide11">
<h1>Python language feature support</h1>
<ul class="simple">
<li>most of <strong>Python 2 syntax</strong> is supported<ul>
<li>top-level classes and functions</li>
<li>control structures: loops, with, try-except/finally, ...</li>
<li>object operations, arithmetic, ...</li>
</ul>
</li>
<li>plus <strong>many Py3 features</strong>:<ul>
<li>list/set/dict comprehensions</li>
<li>keyword-only arguments</li>
<li>extended iterable unpacking (<tt class="docutils literal"><span class="pre">a,b,*c,d</span> <span class="pre">=</span> <span class="pre">some_list</span></tt>)</li>
</ul>
</li>
</ul>
</div>
<div class="slide" id="slide12">
<h1>Python features in work</h1>
<ul>
<li><p class="first">Inner functions with closures</p>
<ul class="simple">
<li>status: (hopefully) to be merged for 0.12</li>
</ul>
<div class="syntax"><pre><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">factory</span>(a,b):
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">closure_function</span>(c):
        <span style="color: #008000; font-weight: bold">return</span> a<span style="color: #666666">+</span>b<span style="color: #666666">+</span>c
    <span style="color: #008000; font-weight: bold">return</span> closure_function
</pre></div>
</li>
</ul>
</div>
<div class="slide" id="slide13">
<h1>Planned Cython features</h1>
<ul class="simple">
<li>improved C++ integration (GSoC 2009)<ul>
<li>e.g. function/operator overloading support</li>
<li>status: mostly there, to be finished and integrated</li>
</ul>
</li>
<li>improved Fortran integration (GSoC 2009)<ul>
<li>talking to Fortan code directly</li>
<li>status: mostly there, to be finished and integrated</li>
</ul>
</li>
<li>native array data type with SIMD behaviour<ul>
<li>status: large interest, implementation pending</li>
</ul>
</li>
</ul>
<p>... as usual: great ideas, little time</p>
</div>
<div class="slide" id="slide14">
<h1>Currently unsupported</h1>
<ul>
<li><p class="first">local/inner classes (~open)</p>
</li>
<li><p class="first">lambda expressions (~easy)</p>
</li>
<li><p class="first">generators (~needs work)</p>
</li>
<li><p class="first">generator expressions (~easy)</p>
<ul>
<li><p class="first">with obvious optimisations, e.g.</p>
<div class="syntax"><pre><span style="color: #008000">set</span>( x<span style="color: #666666">.</span>a <span style="color: #008000; font-weight: bold">for</span> x <span style="color: #AA22FF; font-weight: bold">in</span> some_list )
<span style="color: #666666">==</span> { x<span style="color: #666666">.</span>a <span style="color: #008000; font-weight: bold">for</span> x <span style="color: #AA22FF; font-weight: bold">in</span> some_list }
</pre></div>
</li>
</ul>
</li>
</ul>
<p>... all certainly on the TODO list for 1.0.</p>
</div>
<div class="slide" id="slide15">
<h1>Speed</h1>
<p>Cython generates <strong>very efficient C code</strong>:</p>
<ul class="simple">
<li>PyBench: most benchmarks run 20-80% faster<ul>
<li>conditions and loops run 5-8x faster than in Py2.6.2</li>
<li>overall about 30% faster for plain Python benchmark</li>
<li>obviously, real applications are different</li>
</ul>
</li>
<li>PyPy's <tt class="docutils literal"><span class="pre">richards.py</span></tt> benchmark:<ul>
<li>heavily class based scheduler</li>
<li>20% faster than CPython 2.6.2</li>
</ul>
</li>
</ul>
</div>
<div class="slide" id="slide16">
<h1>Type declarations</h1>
<p>Cython supports <strong>optional</strong> type declarations that</p>
<ul class="simple">
<li>can be employed exactly where performance matters</li>
<li>let Cython generate <strong>plain C</strong> instead of C-API calls</li>
<li>make <tt class="docutils literal"><span class="pre">richards.py</span></tt> benchmark 5x faster than CPython<ul>
<li>without Python code modifications :)</li>
</ul>
</li>
<li>can make code <strong>100 - 1000x faster</strong> than CPython<ul>
<li>expect several 100 times in calculation loops</li>
</ul>
</li>
</ul>
</div>
<div class="slide" id="slide17">
<h1>Part 2: Building Cython modules</h1>
<ul class="simple">
<li>Part 1: Intro to Cython</li>
<li><strong>Part 2: Building Cython modules</strong></li>
<li>Part 3: Writing fast code</li>
<li>Part 4: Talking to other extensions</li>
</ul>
</div>
<div class="slide" id="slide18">
<h1>Ways to build Cython code</h1>
<p>To compile Python code (<tt class="docutils literal"><span class="pre">.py</span></tt>) or Cython code (<tt class="docutils literal"><span class="pre">.pyx</span></tt>)</p>
<ul class="simple">
<li>you need:<ul>
<li>Cython, Python and a C compiler</li>
</ul>
</li>
<li>you can use:<ul>
<li>distutils<ul>
<li><tt class="docutils literal"><span class="pre">setup.py</span></tt> script (likely required anyway)</li>
</ul>
</li>
<li>pyximport<ul>
<li>on-the-fly build + import (for experiments)</li>
</ul>
</li>
<li>Sage notebook<ul>
<li>web app that supports writing and running Cython code</li>
</ul>
</li>
<li><tt class="docutils literal"><span class="pre">cython</span> <span class="pre">source.pyx</span></tt> + manual C compilation</li>
</ul>
</li>
</ul>
</div>
<div class="slide" id="slide19">
<h1>Example: distutils</h1>
<ul>
<li><p class="first">A minimal <tt class="docutils literal"><span class="pre">setup.py</span></tt> script:</p>
<div class="syntax"><pre><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">distutils.core</span> <span style="color: #008000; font-weight: bold">import</span> setup
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">distutils.extension</span> <span style="color: #008000; font-weight: bold">import</span> Extension
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">Cython.Distutils</span> <span style="color: #008000; font-weight: bold">import</span> build_ext

ext_modules <span style="color: #666666">=</span> [Extension(<span style="color: #BA2121">"worker"</span>, [<span style="color: #BA2121">"worker.py"</span>])]

setup(
  name <span style="color: #666666">=</span> <span style="color: #BA2121">'stupid little app'</span>,
  cmdclass <span style="color: #666666">=</span> {<span style="color: #BA2121">'build_ext'</span>: build_ext},
  ext_modules <span style="color: #666666">=</span> ext_modules
)
</pre></div>
</li>
<li><p class="first">Run with</p>
<div class="syntax"><pre><span style="color: #19177C">$ </span>python setup.py build_ext --inplace
</pre></div>
</li>
</ul>
</div>
<div class="slide" id="slide20">
<h1>Example: pyximport</h1>
<p>Build and import Cython code files (<tt class="docutils literal"><span class="pre">.pyx</span></tt>) on the fly</p>
<div class="syntax"><pre><span style="color: #19177C">$ </span>ls
worker.pyx
<span style="color: #19177C">$ PYTHONPATH</span><span style="color: #666666">=</span>. python
</pre></div>
<div class="syntax"><pre><span style="color: #808080">Python 2.6.2 (r262:71600, Apr 17 2009, 11:29:30)</span>
<span style="color: #808080">[GCC 4.3.2] on linux2</span>
<span style="color: #808080">Type "help", "copyright", "credits" or "license" for more information.</span>
<span style="color: #000080; font-weight: bold">&gt;&gt;&gt; </span><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">pyximport</span>
<span style="color: #000080; font-weight: bold">&gt;&gt;&gt; </span>pyximport<span style="color: #666666">.</span>install()

<span style="color: #000080; font-weight: bold">&gt;&gt;&gt; </span><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">worker</span>
<span style="color: #000080; font-weight: bold">&gt;&gt;&gt; </span>worker
<span style="color: #808080">&lt;module 'worker' from '~/.pyxbld/.../worker.so'&gt;</span>
<span style="color: #000080; font-weight: bold">&gt;&gt;&gt; </span>worker<span style="color: #666666">.</span>HardWorker
<span style="color: #808080">&lt;class 'worker.HardWorker'&gt;</span>
<span style="color: #000080; font-weight: bold">&gt;&gt;&gt; </span>worker<span style="color: #666666">.</span>HardWorker(worker<span style="color: #666666">.</span>add_simple_stuff)<span style="color: #666666">.</span>work_hard()
</pre></div>
</div>
<div class="slide" id="slide21">
<h1>pyximporting Python modules</h1>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">pyximport</span></tt> can also compile Python modules:</li>
</ul>
<div class="syntax"><pre><span style="color: #000080; font-weight: bold">&gt;&gt;&gt; </span><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">pyximport</span>
<span style="color: #000080; font-weight: bold">&gt;&gt;&gt; </span>pyximport<span style="color: #666666">.</span>install(pyimport <span style="color: #666666">=</span> <span style="color: #008000">True</span>)
<span style="color: #000080; font-weight: bold">&gt;&gt;&gt; </span><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">shlex</span>
<span style="color: #808080">[lots of compiler errors from different modules ...]</span>
<span style="color: #000080; font-weight: bold">&gt;&gt;&gt; </span>help(shlex)
</pre></div>
<ul class="simple">
<li>currently works for a few stdlib modules</li>
<li>falls back to normal Python import automatically</li>
<li>not production ready, but nice for testing :)</li>
</ul>
</div>
<div class="slide" id="slide22">
<h1>Writing executable programs</h1>
<div class="syntax"><pre><span style="color: #408080; font-style: italic"># file: hw.py</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">hello_world</span>():
    <span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">sys</span>
    <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">"Welcome to Python </span><span style="color: #BB6688; font-weight: bold">%d</span><span style="color: #BA2121">.</span><span style="color: #BB6688; font-weight: bold">%d</span><span style="color: #BA2121">!"</span> <span style="color: #666666">%</span> sys<span style="color: #666666">.</span>version_info[:<span style="color: #666666">2</span>]

<span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span style="color: #BA2121">'__main__'</span>:
    hello_world()
</pre></div>
</div>
<div class="slide" id="slide23">
<h1>Writing executable programs</h1>
<div class="syntax"><pre><span style="color: #408080; font-style: italic"># file: hw.py</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">hello_world</span>():
    <span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">sys</span>
    <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">"Welcome to Python </span><span style="color: #BB6688; font-weight: bold">%d</span><span style="color: #BA2121">.</span><span style="color: #BB6688; font-weight: bold">%d</span><span style="color: #BA2121">!"</span> <span style="color: #666666">%</span> sys<span style="color: #666666">.</span>version_info[:<span style="color: #666666">2</span>]

<span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span style="color: #BA2121">'__main__'</span>:
    hello_world()
</pre></div>
<p>Compile, link and run:</p>
<div class="syntax"><pre><span style="color: #19177C">$ </span>cython --embed hw.py   <span style="color: #408080; font-style: italic"># &lt;- embed a main() function</span>

<span style="color: #19177C">$ </span>gcc <span style="color: #19177C">$CFLAGS</span> -I/usr/include/python2.6 <span style="color: #BB6622; font-weight: bold">\</span>
   -o hw hw.c -lpython2.6 -lpthread -lm -lutil -ldl

<span style="color: #19177C">$ </span>./hw
Welcome to Python 2.6!
</pre></div>
</div>
<div class="slide" id="slide24">
<h1>Part 3: Writing fast code</h1>
<ul class="simple">
<li>Part 1: Intro to Cython</li>
<li>Part 2: Building Cython modules</li>
<li><strong>Part 3: Writing fast code</strong></li>
<li>Part 4: Talking to other extensions</li>
</ul>
</div>
<div class="slide" id="slide25">
<h1>A simple example</h1>
<ul class="simple">
<li>Plain Python code:</li>
</ul>
<div class="syntax"><pre><span style="color: #408080; font-style: italic"># integrate_py.py</span>

<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">math</span> <span style="color: #008000; font-weight: bold">import</span> sin

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">f</span>(x):
    <span style="color: #008000; font-weight: bold">return</span> sin(x<span style="color: #666666">**2</span>)

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">integrate_f</span>(a, b, N):
    dx <span style="color: #666666">=</span> (b<span style="color: #666666">-</span>a)<span style="color: #666666">/</span>N
    s <span style="color: #666666">=</span> <span style="color: #666666">0</span>
    <span style="color: #008000; font-weight: bold">for</span> i <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(N):
        s <span style="color: #666666">+=</span> f(a<span style="color: #666666">+</span>i<span style="color: #666666">*</span>dx)
    <span style="color: #008000; font-weight: bold">return</span> s <span style="color: #666666">*</span> dx
</pre></div>
</div>
<div class="slide" id="slide26">
<h1>Type declarations in Cython</h1>
<p>Function arguments are easy</p>
<ul>
<li><p class="first">Python:</p>
<div class="syntax"><pre><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">f</span>(x):
    <span style="color: #008000; font-weight: bold">return</span> sin(x<span style="color: #666666">**2</span>)
</pre></div>
</li>
<li><p class="first">Cython:</p>
<div class="syntax"><pre><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">f</span>(double x):
    <span style="color: #008000; font-weight: bold">return</span> sin(x<span style="color: #666666">**2</span>)
</pre></div>
</li>
</ul>
</div>
<div class="slide" id="slide27">
<h1>Type declarations in Cython</h1>
<p><strong>»cdef«</strong> keyword declares</p>
<ul>
<li><p class="first">variables with C or builtin types</p>
<div class="syntax"><pre><span style="color: #008000; font-weight: bold">cdef</span> <span style="color: #B00040">double</span> <span style="color: #0000FF">dx</span>, <span style="color: #0000FF">s</span>
</pre></div>
</li>
<li><p class="first">functions with C signatures</p>
<div class="syntax"><pre><span style="color: #008000; font-weight: bold">cdef</span> <span style="color: #B00040">double</span> <span style="color: #0000FF">f</span>(double x):
    <span style="color: #008000; font-weight: bold">return</span> sin(x<span style="color: #666666">**2</span>)
</pre></div>
</li>
<li><p class="first">classes as 'builtin' extension types</p>
<div class="syntax"><pre><span style="color: #008000; font-weight: bold">cdef</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF">MyType</span>:
    <span style="color: #008000; font-weight: bold">cdef</span> <span style="color: #B00040">int</span> <span style="color: #0000FF">field</span>
</pre></div>
</li>
</ul>
</div>
<div class="slide" id="slide28">
<h1>Functions: def vs. cdef vs. cpdef</h1>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">def</span> <span class="pre">func(int</span> <span class="pre">x)</span></tt>:<ul>
<li>part of the Python module API</li>
<li>Python call semantics</li>
</ul>
</li>
<li><tt class="docutils literal"><span class="pre">cdef</span> <span class="pre">int</span> <span class="pre">func(int</span> <span class="pre">x)</span></tt>:<ul>
<li>C signature</li>
<li>C call semantics</li>
</ul>
</li>
<li><tt class="docutils literal"><span class="pre">cpdef</span> <span class="pre">int</span> <span class="pre">func(int</span> <span class="pre">x)</span></tt>:<ul>
<li>Python wrapper around cdef function</li>
<li>C calls cdef function, Python calls wrapper</li>
<li>note: modified C signature!</li>
</ul>
</li>
</ul>
</div>
<div class="slide" id="slide29">
<h1>Typed arguments and return values</h1>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">def</span> <span class="pre">func(int</span> <span class="pre">x)</span></tt>:<ul>
<li>caller passes Python objects for <tt class="docutils literal"><span class="pre">x</span></tt></li>
<li>function converts to <tt class="docutils literal"><span class="pre">int</span></tt> on entry</li>
<li>implicit return type always <tt class="docutils literal"><span class="pre">object</span></tt></li>
</ul>
</li>
<li><tt class="docutils literal"><span class="pre">cdef</span> <span class="pre">int</span> <span class="pre">func(int</span> <span class="pre">x)</span></tt>:<ul>
<li>caller converts arguments as required</li>
<li>function receives C <tt class="docutils literal"><span class="pre">int</span></tt> for <tt class="docutils literal"><span class="pre">x</span></tt></li>
<li>arbitrary return type, defaults to <tt class="docutils literal"><span class="pre">object</span></tt></li>
</ul>
</li>
<li><tt class="docutils literal"><span class="pre">cpdef</span> <span class="pre">int</span> <span class="pre">func(int</span> <span class="pre">x)</span></tt>:<ul>
<li>C callers convert arguments as required</li>
<li>Python callers pass and receive objects<ul>
<li>wrapper converts</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="slide" id="slide30">
<h1>A simple example: Python</h1>
<div class="syntax"><pre><span style="color: #408080; font-style: italic"># integrate_py.py</span>

<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">math</span> <span style="color: #008000; font-weight: bold">import</span> sin

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">f</span>(x):
    <span style="color: #008000; font-weight: bold">return</span> sin(x<span style="color: #666666">**2</span>)

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">integrate_f</span>(a, b, N):
    dx <span style="color: #666666">=</span> (b<span style="color: #666666">-</span>a)<span style="color: #666666">/</span>N
    s <span style="color: #666666">=</span> <span style="color: #666666">0</span>
    <span style="color: #008000; font-weight: bold">for</span> i <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(N):
        s <span style="color: #666666">+=</span> f(a<span style="color: #666666">+</span>i<span style="color: #666666">*</span>dx)
    <span style="color: #008000; font-weight: bold">return</span> s <span style="color: #666666">*</span> dx
</pre></div>
</div>
<div class="slide" id="slide31">
<h1>A simple example: Cython</h1>
<div class="syntax"><pre><span style="color: #408080; font-style: italic"># integrate_cy.pyx</span>

<span style="color: #008000; font-weight: bold">cdef</span> <span style="color: #008000; font-weight: bold">extern</span> <span style="color: #008000; font-weight: bold">from</span> <span style="color: #BA2121">"math.h"</span>:
    double sin(double x)

<span style="color: #008000; font-weight: bold">cdef</span> <span style="color: #B00040">double</span> <span style="color: #0000FF">f</span>(double x):
    <span style="color: #008000; font-weight: bold">return</span> sin(x<span style="color: #666666">**2</span>)

<span style="color: #008000; font-weight: bold">cpdef</span> <span style="color: #B00040">double</span> <span style="color: #0000FF">integrate_f</span>(double a, double b, <span style="color: #008000">int</span> N):
    <span style="color: #008000; font-weight: bold">cdef</span> <span style="color: #B00040">double</span> <span style="color: #0000FF">dx</span>, <span style="color: #0000FF">s</span>
    <span style="color: #008000; font-weight: bold">cdef</span> <span style="color: #B00040">int</span> <span style="color: #0000FF">i</span>

    dx <span style="color: #666666">=</span> (b<span style="color: #666666">-</span>a)<span style="color: #666666">/</span>N
    s <span style="color: #666666">=</span> <span style="color: #666666">0</span>
    <span style="color: #008000; font-weight: bold">for</span> i <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(N):
        s <span style="color: #666666">+=</span> f(a<span style="color: #666666">+</span>i<span style="color: #666666">*</span>dx)
    <span style="color: #008000; font-weight: bold">return</span> s <span style="color: #666666">*</span> dx
</pre></div>
</div>
<div class="slide" id="slide32">
<h1>Overriding declarations in .pxd</h1>
<ul class="simple">
<li>Plain Python code:</li>
</ul>
<div class="syntax"><pre><span style="color: #408080; font-style: italic"># integrate_py.py</span>

<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">math</span> <span style="color: #008000; font-weight: bold">import</span> sin

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">f</span>(x):
    <span style="color: #008000; font-weight: bold">return</span> sin(x<span style="color: #666666">**2</span>)

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">integrate_f</span>(a, b, N):
    dx <span style="color: #666666">=</span> (b<span style="color: #666666">-</span>a)<span style="color: #666666">/</span>N
    s <span style="color: #666666">=</span> <span style="color: #666666">0</span>
    <span style="color: #008000; font-weight: bold">for</span> i <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(N):
        s <span style="color: #666666">+=</span> f(a<span style="color: #666666">+</span>i<span style="color: #666666">*</span>dx)
    <span style="color: #008000; font-weight: bold">return</span> s <span style="color: #666666">*</span> dx
</pre></div>
</div>
<div class="slide" id="slide33">
<h1>Overriding declarations in .pxd</h1>
<table border="1" class="docutils">
<colgroup>
<col width="45%">
<col width="55%">
</colgroup>
<tbody valign="top">
<tr><td>Python <tt class="docutils literal"><span class="pre">integrate_py.py</span></tt></td>
<td>Cython <tt class="docutils literal"><span class="pre">integrate_py.pxd</span></tt></td>
</tr>
<tr><td><div class="first last"><div class="syntax"><pre><span style="color: #408080; font-style: italic"># integrate_py.py</span>

<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">math</span> <span style="color: #008000; font-weight: bold">import</span> sin

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">f</span>(x):
    <span style="color: #008000; font-weight: bold">return</span> sin(x<span style="color: #666666">**2</span>)


<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">integrate_f</span>(a, b, N):

    dx <span style="color: #666666">=</span> (b<span style="color: #666666">-</span>a)<span style="color: #666666">/</span>N
    s <span style="color: #666666">=</span> <span style="color: #666666">0</span>
    <span style="color: #008000; font-weight: bold">for</span> i <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(N):
        s <span style="color: #666666">+=</span> f(a<span style="color: #666666">+</span>i<span style="color: #666666">*</span>dx)
    <span style="color: #008000; font-weight: bold">return</span> s <span style="color: #666666">*</span> dx
</pre></div>
</div></td>
<td><div class="first last"><div class="syntax"><pre><span style="color: #408080; font-style: italic"># integrate_py.pxd</span>
<span style="color: #008000; font-weight: bold">cimport</span> <span style="color: #0000FF; font-weight: bold">cython</span>


<span style="color: #008000; font-weight: bold">cpdef</span> <span style="color: #B00040">double</span> <span style="color: #0000FF">f</span>(double x)

<span style="color: #AA22FF">@cython</span><span style="color: #666666">.</span>locals(
    dx<span style="color: #666666">=</span>double, s<span style="color: #666666">=</span>double, i<span style="color: #666666">=</span><span style="color: #008000">int</span>)
<span style="color: #008000; font-weight: bold">cpdef</span> <span style="color: #0000FF">integrate_f</span>(
    double a, double b, <span style="color: #008000">int</span> N)
</pre></div>
</div></td>
</tr>
</tbody>
</table>
</div>
<div class="slide" id="slide34">
<h1>The .pxd file used</h1>
<div class="syntax"><pre><span style="color: #408080; font-style: italic"># integrate_py.pxd</span>

<span style="color: #008000; font-weight: bold">cimport</span> <span style="color: #0000FF; font-weight: bold">cython</span>

<span style="color: #008000; font-weight: bold">cpdef</span> <span style="color: #B00040">double</span> <span style="color: #0000FF">f</span>(double x):
    <span style="color: #008000; font-weight: bold">return</span> sin(x<span style="color: #666666">**2</span>)

<span style="color: #008000; font-weight: bold">cpdef</span> <span style="color: #B00040">double</span> <span style="color: #0000FF">integrate_f</span>(double a, double b, <span style="color: #008000">int</span> N)
</pre></div>
</div>
<div class="slide" id="slide35">
<h1>Overriding declarations in .pxd</h1>
<ul class="simple">
<li>advantage:<ul>
<li>plain Python code<ul>
<li>runs unchanged in Python interpreter</li>
</ul>
</li>
<li>complete Python tool-chain available<ul>
<li>Eclipse, pylint, 2to3, ...</li>
</ul>
</li>
</ul>
</li>
<li>drawback:<ul>
<li>no access to C functions<ul>
<li>cannot override <tt class="docutils literal"><span class="pre">from</span> <span class="pre">math</span> <span class="pre">import</span> <span class="pre">sin</span></tt></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="slide" id="slide36">
<h1>Typing in Python syntax</h1>
<ul class="simple">
<li>Plain Python code:</li>
</ul>
<div class="syntax"><pre><span style="color: #408080; font-style: italic"># integrate_py.py</span>

<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">math</span> <span style="color: #008000; font-weight: bold">import</span> sin

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">f</span>(x):
    <span style="color: #008000; font-weight: bold">return</span> sin(x<span style="color: #666666">**2</span>)

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">integrate_f</span>(a, b, N):
    dx <span style="color: #666666">=</span> (b<span style="color: #666666">-</span>a)<span style="color: #666666">/</span>N
    s <span style="color: #666666">=</span> <span style="color: #666666">0</span>
    <span style="color: #008000; font-weight: bold">for</span> i <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(N):
        s <span style="color: #666666">+=</span> f(a<span style="color: #666666">+</span>i<span style="color: #666666">*</span>dx)
    <span style="color: #008000; font-weight: bold">return</span> s <span style="color: #666666">*</span> dx
</pre></div>
</div>
<div class="slide" id="slide37">
<h1>Typing in Python syntax</h1>
<ul class="simple">
<li><a class="reference external" href="http://wiki.cython.org/pure">http://wiki.cython.org/pure</a></li>
</ul>
<div class="syntax"><pre><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">math</span> <span style="color: #008000; font-weight: bold">import</span> sin
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">cython</span>

<span style="color: #AA22FF">@cython.locals</span>(x<span style="color: #666666">=</span>cython<span style="color: #666666">.</span>double)
<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">f</span>(x):
    <span style="color: #008000; font-weight: bold">return</span> sin(x<span style="color: #666666">**2</span>)

<span style="color: #AA22FF">@cython.locals</span>(a<span style="color: #666666">=</span>cython<span style="color: #666666">.</span>double, b<span style="color: #666666">=</span>cython<span style="color: #666666">.</span>double,
               N<span style="color: #666666">=</span>cython<span style="color: #666666">.</span>Py_ssize_t, dx<span style="color: #666666">=</span>cython<span style="color: #666666">.</span>double,
               s<span style="color: #666666">=</span>cython<span style="color: #666666">.</span>double, i<span style="color: #666666">=</span>cython<span style="color: #666666">.</span>Py_ssize_t)
<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">integrate_f</span>(a, b, N):
    dx <span style="color: #666666">=</span> (b<span style="color: #666666">-</span>a)<span style="color: #666666">/</span>N
    s <span style="color: #666666">=</span> <span style="color: #666666">0</span>
    <span style="color: #008000; font-weight: bold">for</span> i <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(N):
        s <span style="color: #666666">+=</span> f(a<span style="color: #666666">+</span>i<span style="color: #666666">*</span>dx)
    <span style="color: #008000; font-weight: bold">return</span> s <span style="color: #666666">*</span> dx
</pre></div>
</div>
<div class="slide" id="slide38">
<h1>Declaring Python types</h1>
<ul class="simple">
<li>Access to Python's builtins is heavily optimised<ul>
<li><tt class="docutils literal"><span class="pre">for</span> <span class="pre">...</span> <span class="pre">in</span></tt> range()/list/tuple/dict</li>
<li><tt class="docutils literal"><span class="pre">list.append()</span></tt>, <tt class="docutils literal"><span class="pre">list.reverse()</span></tt></li>
<li><tt class="docutils literal"><span class="pre">set([...])</span></tt>, <tt class="docutils literal"><span class="pre">tuple([...])</span></tt></li>
</ul>
</li>
<li>Further improvements in Cython 0.12<ul>
<li>replacements for <tt class="docutils literal"><span class="pre">enumerate()</span></tt>, <tt class="docutils literal"><span class="pre">type()</span></tt></li>
<li><tt class="docutils literal"><span class="pre">dict([...])</span></tt>, <tt class="docutils literal"><span class="pre">unicode.encode()</span></tt>, <tt class="docutils literal"><span class="pre">list.sort()</span></tt></li>
</ul>
</li>
<li>Declaring Python types is often worth it!</li>
</ul>
<ul class=" simple">
<li class="">Easy to add new optimisations<ul>
<li>don't write prematurely optimised code, fix Cython!</li>
</ul>
</li>
</ul>
</div>
<div class="slide" id="slide39">
<h1>Declaring Python types: dict</h1>
<ul class="simple">
<li>example: dict iteration</li>
</ul>
<div class="syntax"><pre><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">filter_a</span>(d):
    <span style="color: #008000; font-weight: bold">return</span> { key : value
             <span style="color: #008000; font-weight: bold">for</span> key, value <span style="color: #AA22FF; font-weight: bold">in</span> d<span style="color: #666666">.</span>iteritems()
             <span style="color: #008000; font-weight: bold">if</span> <span style="color: #BA2121">'a'</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #AA22FF; font-weight: bold">in</span> value }

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">string</span>
d <span style="color: #666666">=</span> { s:s <span style="color: #008000; font-weight: bold">for</span> s <span style="color: #AA22FF; font-weight: bold">in</span> string<span style="color: #666666">.</span>ascii_letters }
<span style="color: #008000; font-weight: bold">print</span> filter_a(d)
</pre></div>
</div>
<div class="slide" id="slide40">
<h1>Declaring Python types: dict</h1>
<ul class="simple">
<li>simple change, ~30% faster:</li>
</ul>
<div class="syntax"><pre><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">filter_a</span>(<span style="color: #008000">dict</span> d):       <span style="color: #408080; font-style: italic"># &lt;====</span>
    <span style="color: #008000; font-weight: bold">return</span> { key : value
             <span style="color: #008000; font-weight: bold">for</span> key, value <span style="color: #AA22FF; font-weight: bold">in</span> d<span style="color: #666666">.</span>iteritems()
             <span style="color: #008000; font-weight: bold">if</span> <span style="color: #BA2121">'a'</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #AA22FF; font-weight: bold">in</span> value }

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">string</span>
d <span style="color: #666666">=</span> { s:s <span style="color: #008000; font-weight: bold">for</span> s <span style="color: #AA22FF; font-weight: bold">in</span> string<span style="color: #666666">.</span>ascii_letters }
<span style="color: #008000; font-weight: bold">print</span> filter_a(d)
</pre></div>
</div>
<div class="slide" id="slide41">
<h1>Declaring Python types: dict</h1>
<ul class="simple">
<li>simple change, ~30% faster:</li>
</ul>
<div class="syntax"><pre><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">filter_a</span>(<span style="color: #008000">dict</span> d):       <span style="color: #408080; font-style: italic"># &lt;====</span>
    <span style="color: #008000; font-weight: bold">return</span> { key : value
             <span style="color: #008000; font-weight: bold">for</span> key, value <span style="color: #AA22FF; font-weight: bold">in</span> d<span style="color: #666666">.</span>iteritems()
             <span style="color: #008000; font-weight: bold">if</span> <span style="color: #BA2121">'a'</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #AA22FF; font-weight: bold">in</span> value }

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">string</span>
d <span style="color: #666666">=</span> { s:s <span style="color: #008000; font-weight: bold">for</span> s <span style="color: #AA22FF; font-weight: bold">in</span> string<span style="color: #666666">.</span>ascii_letters }
<span style="color: #008000; font-weight: bold">print</span> filter_a(d)
</pre></div>
<ul class="simple">
<li>drawback:<ul>
<li>non-dict mapping arguments raise a <tt class="docutils literal"><span class="pre">TypeError</span></tt></li>
</ul>
</li>
</ul>
</div>
<div class="slide" id="slide42">
<h1>Think twice before you type</h1>
<img alt="SimplicityVsSpeed.png" src="./Using the Cython Compiler to write fast Python code_files/SimplicityVsSpeed.png">
<ul class="simple">
<li>benchmark code before adding static types!</li>
</ul>
</div>
<div class="slide" id="slide43">
<h1>Classes</h1>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">class</span> <span class="pre">MyClass(object):</span></tt><ul>
<li>Python class with <tt class="docutils literal"><span class="pre">__dict__</span></tt></li>
<li>multiple inheritance</li>
<li>arbitrary Python attributes</li>
<li>Python methods</li>
<li>monkey-patcheable etc.</li>
</ul>
</li>
<li><tt class="docutils literal"><span class="pre">cdef</span> <span class="pre">class</span> <span class="pre">MyClass(SomeSuperClass):</span></tt><ul>
<li>"builtin" extension type</li>
<li>single inheritance<ul>
<li>only from other extension types!</li>
</ul>
</li>
<li>fixed, typed fields<ul>
<li>C-only access by default, or <tt class="docutils literal"><span class="pre">readonly</span></tt>/<tt class="docutils literal"><span class="pre">public</span></tt></li>
</ul>
</li>
<li>Python + C methods</li>
</ul>
</li>
</ul>
</div>
<div class="slide" id="slide44">
<h1>cdef classes - when to use them?</h1>
<ul class="simple">
<li>Use cdef classes<ul>
<li>when C attribute types are used<ul>
<li>e.g. whenever wrapping C structs/pointers/etc.</li>
</ul>
</li>
<li>when the need for speed beats Python's generality</li>
</ul>
</li>
<li>Use Python classes<ul>
<li>for bytes/tuple subtypes (<tt class="docutils literal"><span class="pre">PyVarObject</span></tt>)</li>
<li>for exceptions if Py&lt;2.5 compatibility is required</li>
<li>when multiple inheritance is required</li>
<li>when users are allowed to monkey-patch</li>
</ul>
</li>
</ul>
</div>
<div class="slide" id="slide45">
<h1>Part 4: Talking to other extensions</h1>
<ul class="simple">
<li>Part 1: Intro to Cython</li>
<li>Part 2: Building Cython modules</li>
<li>Part 3: Writing fast code</li>
<li><strong>Part 4: Talking to other extensions</strong></li>
</ul>
</div>
<div class="slide" id="slide46">
<h1>Talking to other extensions</h1>
<ul class="simple">
<li>Python 3 buffer protocol (available in Py2.6)</li>
<li>external C-APIs</li>
</ul>
</div>
<div class="slide" id="slide47">
<h1>Python 3 buffer protocol</h1>
<ul class="simple">
<li>Native support for new Python <tt class="docutils literal"><span class="pre">buffer</span></tt> protocol<ul>
<li>PEP 3118</li>
</ul>
</li>
</ul>
<div class="syntax"><pre><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">inplace_invert_2D_buffer</span>(
                <span style="color: #008000">object</span>[unsigned char, <span style="color: #666666">2</span>] image):

    <span style="color: #008000; font-weight: bold">cdef</span> <span style="color: #B00040">int</span> <span style="color: #0000FF">i</span>, <span style="color: #0000FF">j</span>
    <span style="color: #008000; font-weight: bold">for</span> i <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(image<span style="color: #666666">.</span>shape[<span style="color: #666666">0</span>]):
        <span style="color: #008000; font-weight: bold">for</span> j <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(image<span style="color: #666666">.</span>shape[<span style="color: #666666">1</span>]):
            image[i, j] <span style="color: #666666">=</span> <span style="color: #666666">255</span> <span style="color: #666666">-</span> image[i, j]
</pre></div>
<ul class="simple">
<li>can be supported for extension types in Py2.x<ul>
<li>declared through <tt class="docutils literal"><span class="pre">.pxd</span></tt> files</li>
<li>Cython ships with <tt class="docutils literal"><span class="pre">numpy.pxd</span></tt></li>
<li><tt class="docutils literal"><span class="pre">array.pxd</span></tt> available (stdlib's <tt class="docutils literal"><span class="pre">array</span></tt>)</li>
</ul>
</li>
</ul>
</div>
<div class="slide" id="slide48">
<h1>Conclusion</h1>
<ul class="simple">
<li>Cython is a tool for<ul>
<li>translating Python code to efficient C</li>
<li>easily interfacing to external C/C++/Fortran code</li>
</ul>
</li>
<li>Use it to<ul>
<li>speed up existing Python modules<ul>
<li>concentrate on optimisations, not rewrites!</li>
</ul>
</li>
<li>write C extensions for CPython<ul>
<li>don't change the language just to get fast code!</li>
</ul>
</li>
<li>wrap C libraries <em>in Python</em><ul>
<li>concentrate on the mapping, not the glue!</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="slide" id="slide49">
<h1>... but Cython is also</h1>
<ul class="simple">
<li>a great project</li>
<li>a very open playground for great ideas!</li>
</ul>
</div>
<div class="slide" id="slide50">
<h1>Cython</h1>
<blockquote>
<p><strong>Cython</strong></p>
<p><strong>C-Extensions in Python</strong></p>
<p>... use it, and join the project!</p>
<p><a class="reference external" href="http://cython.org/">http://cython.org/</a></p>
</blockquote>
</div>
</div>


</body></html>